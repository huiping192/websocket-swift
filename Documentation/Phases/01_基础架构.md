# é˜¶æ®µ1: åŸºç¡€æ¶æ„å®ç°

## ğŸ¯ å­¦ä¹ ç›®æ ‡

é€šè¿‡å®ç°ç½‘ç»œä¼ è¾“å±‚å’ŒHTTPå‡çº§æ¡æ‰‹ï¼ŒæŒæ¡ï¼š
- TCPç½‘ç»œç¼–ç¨‹åŸºç¡€
- HTTPåè®®è§£æå’Œæ„å»º
- Swift Networkæ¡†æ¶ä½¿ç”¨
- å¼‚æ­¥I/Oç¼–ç¨‹æ¨¡å¼
- é”™è¯¯å¤„ç†å’ŒçŠ¶æ€ç®¡ç†

## ğŸ“‹ è¯¦ç»†Todoæ¸…å•

### ç½‘ç»œä¼ è¾“å±‚ (NetworkTransport)

#### 1.1 TCPè¿æ¥ç®¡ç†
- [x] **å®ç°TCPTransportç±»**
  - âœ… ä½¿ç”¨Network.frameworkçš„NWConnection
  - âœ… æ”¯æŒIPv4å’ŒIPv6
  - âœ… å®ç°è¿æ¥çŠ¶æ€ç›‘å¬
  - âœ… æ·»åŠ è¿æ¥è¶…æ—¶å¤„ç†

```swift
// å®ç°ç›®æ ‡
public final class TCPTransport: NetworkTransportProtocol {
    private var connection: NWConnection?
    private let queue = DispatchQueue(label: "tcp.transport")
    
    public func connect(to host: String, port: Int, useTLS: Bool) async throws {
        // TODO: å®ç°TCPè¿æ¥
    }
}
```

- [x] **å¼‚æ­¥æ•°æ®æ”¶å‘**
  - âœ… å®ç°send(data:)æ–¹æ³•
  - âœ… å®ç°receive()æ–¹æ³•  
  - âœ… å¤„ç†éƒ¨åˆ†å‘é€/æ¥æ”¶æƒ…å†µ
  - âœ… æ·»åŠ ç¼“å†²åŒºç®¡ç†

- [x] **è¿æ¥ç”Ÿå‘½å‘¨æœŸç®¡ç†**
  - âœ… è¿æ¥çŠ¶æ€è·Ÿè¸ª
  - âœ… ä¼˜é›…å…³é—­å¤„ç†
  - âœ… ç½‘ç»œé”™è¯¯æ£€æµ‹
  - âœ… è¿æ¥é‡è¯•é€»è¾‘

#### 1.2 TLSå®‰å…¨ä¼ è¾“
- [x] **TLSé…ç½®**
  - âœ… æ”¯æŒTLS 1.2/1.3
  - âœ… è¯ä¹¦éªŒè¯ç­–ç•¥
  - âœ… è‡ªç­¾åè¯ä¹¦å¤„ç†ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
  - âœ… SNIæ”¯æŒ

- [x] **å®‰å…¨ç­–ç•¥**
  - âœ… ä¸»æœºåéªŒè¯
  - âœ… è¯ä¹¦å›ºå®šï¼ˆå¯é€‰ï¼‰
  - âœ… åŠ å¯†å¥—ä»¶é…ç½®
  - âœ… åè®®ç‰ˆæœ¬é™åˆ¶

### HTTPå‡çº§æ¡æ‰‹ (HTTPUpgrade)

#### 1.3 æ¡æ‰‹è¯·æ±‚æ„å»º
- [x] **RequestBuilderå®ç°**
  - âœ… HTTP/1.1è¯·æ±‚æ ¼å¼åŒ–
  - âœ… å¿…éœ€å¤´éƒ¨å­—æ®µç”Ÿæˆ
  - âœ… Sec-WebSocket-Keyç”Ÿæˆ
  - âœ… å­åè®®å’Œæ‰©å±•æ”¯æŒ

```swift
// å®ç°ç›®æ ‡
public struct RequestBuilder {
    public func buildUpgradeRequest(for url: URL) -> String {
        // TODO: æ„å»ºå®Œæ•´çš„HTTPå‡çº§è¯·æ±‚
    }
}
```

- [x] **å¯†é’¥ç”Ÿæˆå’ŒéªŒè¯**
  - âœ… 16å­—èŠ‚éšæœºå¯†é’¥ç”Ÿæˆ
  - âœ… Base64ç¼–ç å¤„ç†
  - âœ… Acceptå¯†é’¥è®¡ç®—éªŒè¯
  - âœ… é­”æœ¯å­—ç¬¦ä¸²å¸¸é‡

#### 1.4 æ¡æ‰‹å“åº”è§£æ
- [x] **ResponseParserå®ç°**
  - âœ… HTTPå“åº”çŠ¶æ€è¡Œè§£æ
  - âœ… å¤´éƒ¨å­—æ®µè§£æ
  - âœ… Sec-WebSocket-AcceptéªŒè¯
  - âœ… åè®®åå•†ç»“æœå¤„ç†

- [x] **é”™è¯¯å¤„ç†**
  - âœ… é101çŠ¶æ€ç å¤„ç†
  - âœ… ç¼ºå¤±å¿…éœ€å¤´éƒ¨æ£€æµ‹
  - âœ… æ— æ•ˆAcceptå¯†é’¥æ‹’ç»
  - âœ… åè®®åå•†å¤±è´¥å¤„ç†

#### 1.5 æ¡æ‰‹ç®¡ç†å™¨
- [x] **HandshakeManagerå®ç°**
  - âœ… å®Œæ•´æ¡æ‰‹æµç¨‹æ§åˆ¶
  - âœ… è¶…æ—¶ç®¡ç†
  - âœ… çŠ¶æ€è·Ÿè¸ª
  - âœ… é”™è¯¯æ¢å¤

```swift
// å®ç°ç›®æ ‡
public final class HandshakeManager: HandshakeManagerProtocol {
    public func performHandshake(
        url: URL,
        transport: NetworkTransportProtocol
    ) async throws -> HandshakeResult {
        // TODO: å®ç°å®Œæ•´æ¡æ‰‹æµç¨‹
    }
}
```

### å·¥å…·æ”¯æŒ (Utilities)

#### 1.6 åŠ å¯†å·¥å…·
- [x] **CryptoUtilitieså®ç°**
  - âœ… SHA-1å“ˆå¸Œè®¡ç®—
  - âœ… Base64ç¼–ç /è§£ç 
  - âœ… éšæœºæ•°ç”Ÿæˆ
  - âœ… æ©ç å¯†é’¥ç”Ÿæˆ

- [x] **æ•°æ®å¤„ç†æ‰©å±•**
  - âœ… Dataçš„åå…­è¿›åˆ¶è½¬æ¢
  - âœ… Stringçš„UTF-8å¤„ç†
  - âœ… å­—èŠ‚åºè½¬æ¢å·¥å…·
  - âœ… æ•°æ®æ©ç å¤„ç†

#### 1.7 æ—¥å¿—å’Œè°ƒè¯•
- [x] **æ—¥å¿—ç³»ç»Ÿ**
  - âœ… ç»“æ„åŒ–æ—¥å¿—è®°å½•
  - âœ… ä¸åŒæ—¥å¿—çº§åˆ«
  - âœ… ç½‘ç»œæ•°æ®åŒ…è®°å½•
  - âœ… æ€§èƒ½æŒ‡æ ‡æ”¶é›†

## ğŸ”§ æŠ€æœ¯è¦ç‚¹

### TCPè¿æ¥æœ€ä½³å®è·µ

```swift
// è¿æ¥é…ç½®
let parameters = NWParameters.tcp
parameters.requiredInterfaceType = .wifi  // å¯é€‰ï¼šæŒ‡å®šç½‘ç»œæ¥å£
parameters.serviceClass = .responsiveData  // ä½å»¶è¿Ÿä¼˜åŒ–

// IPv6ä¼˜å…ˆé…ç½®
parameters.preferNoProxies = true
parameters.multipathServiceType = .disabled
```

### HTTPè¯·æ±‚æ ¼å¼

```
GET /chat HTTP/1.1\r\n
Host: server.example.com\r\n
Upgrade: websocket\r\n
Connection: Upgrade\r\n
Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ==\r\n
Sec-WebSocket-Version: 13\r\n
Sec-WebSocket-Protocol: chat, superchat\r\n
Origin: http://example.com\r\n
\r\n
```

### Acceptå¯†é’¥è®¡ç®—

```swift
import CryptoKit

func computeWebSocketAccept(key: String) -> String {
    let magicString = "258EAFA5-E914-47DA-95CA-C5AB0DC85B11"
    let combined = key + magicString
    let data = Data(combined.utf8)
    let hash = Insecure.SHA1.hash(data: data)
    return Data(hash).base64EncodedString()
}
```

### å¼‚æ­¥é”™è¯¯å¤„ç†

```swift
enum NetworkError: Error {
    case connectionTimeout
    case hostUnreachable
    case tlsHandshakeFailed
    case connectionReset
    case invalidResponse
}

// ä½¿ç”¨Resultç±»å‹å¤„ç†å¼‚æ­¥ç»“æœ
typealias ConnectionResult = Result<NWConnection, NetworkError>
```

## ğŸ§ª æµ‹è¯•è®¡åˆ’

### å•å…ƒæµ‹è¯•
- [ ] **TCPè¿æ¥æµ‹è¯•**
  - æˆåŠŸè¿æ¥åˆ°å›ç¯åœ°å€
  - è¿æ¥è¶…æ—¶å¤„ç†
  - æ— æ•ˆä¸»æœºåå¤„ç†
  - ç½‘ç»œä¸å¯è¾¾å¤„ç†

- [ ] **TLSè¿æ¥æµ‹è¯•**
  - HTTPSç«™ç‚¹è¿æ¥
  - è¯ä¹¦éªŒè¯æµ‹è¯•
  - TLSç‰ˆæœ¬åå•†
  - æ¡æ‰‹å¤±è´¥å¤„ç†

- [ ] **HTTPè§£ææµ‹è¯•**
  - æ ‡å‡†æ¡æ‰‹è¯·æ±‚è§£æ
  - å“åº”çŠ¶æ€ç å¤„ç†
  - å¤´éƒ¨å­—æ®µè§£æ
  - Acceptå¯†é’¥éªŒè¯

### é›†æˆæµ‹è¯•
- [ ] **ç«¯åˆ°ç«¯æ¡æ‰‹æµ‹è¯•**
  - ä¸WebSocketæµ‹è¯•æœåŠ¡å™¨æ¡æ‰‹
  - echo.websocket.orgè¿æ¥æµ‹è¯•
  - åè®®åå•†æµ‹è¯•
  - é”™è¯¯åœºæ™¯æµ‹è¯•

- [ ] **æ€§èƒ½æµ‹è¯•**
  - è¿æ¥å»ºç«‹å»¶è¿Ÿ
  - æ•°æ®ä¼ è¾“ååé‡
  - å†…å­˜ä½¿ç”¨ç›‘æ§
  - å¹¶å‘è¿æ¥æµ‹è¯•

### æµ‹è¯•æœåŠ¡å™¨æ­å»º

```swift
// ç®€å•çš„æµ‹è¯•æœåŠ¡å™¨mock
class MockWebSocketServer {
    func handleUpgradeRequest(_ request: String) -> String {
        // è§£æè¯·æ±‚å¹¶è¿”å›101å“åº”
        return \"HTTP/1.1 101 Switching Protocols\\r\\n\" +
               \"Upgrade: websocket\\r\\n\" +
               \"Connection: Upgrade\\r\\n\" +
               \"Sec-WebSocket-Accept: accept-key\\r\\n\\r\\n\"
    }
}
```

## ğŸ¯ éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½è¦æ±‚
- âœ… TCPè¿æ¥æˆåŠŸå»ºç«‹å’Œå…³é—­
- âœ… TLSè¿æ¥æ”¯æŒï¼ˆwss://åè®®ï¼‰
- âœ… HTTPå‡çº§è¯·æ±‚æ­£ç¡®æ„å»º
- âœ… æ¡æ‰‹å“åº”æ­£ç¡®è§£æå’ŒéªŒè¯
- âœ… é”™è¯¯æƒ…å†µä¼˜é›…å¤„ç†
- âœ… æ‰€æœ‰å•å…ƒæµ‹è¯•é€šè¿‡
- âœ… é›†æˆæµ‹è¯•è¿æ¥æˆåŠŸ

### æ€§èƒ½è¦æ±‚
- è¿æ¥å»ºç«‹æ—¶é—´ < 5ç§’
- æ¡æ‰‹å®Œæˆæ—¶é—´ < 2ç§’
- å†…å­˜å ç”¨ < 10MBï¼ˆå•è¿æ¥ï¼‰
- æ”¯æŒè‡³å°‘100ä¸ªå¹¶å‘è¿æ¥

### ä»£ç è´¨é‡
- 90%ä»¥ä¸Šæµ‹è¯•è¦†ç›–ç‡
- æ‰€æœ‰å…¬å¼€APIæœ‰æ–‡æ¡£æ³¨é‡Š
- éµå¾ªSwiftä»£ç è§„èŒƒ
- æ— è­¦å‘Šç¼–è¯‘é€šè¿‡

## ğŸ“š å‚è€ƒèµ„æ–™

### ç½‘ç»œç¼–ç¨‹
- [Apple Network Frameworkæ–‡æ¡£](https://developer.apple.com/documentation/network)
- [TCPåè®®RFC 793](https://tools.ietf.org/html/rfc793)
- [TLS 1.3 RFC 8446](https://tools.ietf.org/html/rfc8446)

### HTTPåè®®
- [HTTP/1.1 RFC 7230](https://tools.ietf.org/html/rfc7230)
- [WebSocketæ¡æ‰‹ RFC 6455 Section 4](https://tools.ietf.org/html/rfc6455#section-4)

### Swiftå¼‚æ­¥ç¼–ç¨‹
- [Swift Concurrencyæ–‡æ¡£](https://docs.swift.org/swift-book/LanguageGuide/Concurrency.html)
- [Structured Concurrencyæœ€ä½³å®è·µ](https://www.swift.org/blog/structured-concurrency/)

### æµ‹è¯•å·¥å…·
- [WebSocketæµ‹è¯•å·¥å…·](https://www.websocket.org/echo.html)
- [Autobahnæµ‹è¯•å¥—ä»¶](https://github.com/crossbario/autobahn-testsuite)

## ğŸ’¡ å®ç°æç¤º

1. **å…ˆå®ç°TCPï¼Œå†åŠ TLS** - åˆ†æ­¥å®ç°é™ä½å¤æ‚åº¦
2. **ä½¿ç”¨Protocol Oriented Programming** - ä¾¿äºæµ‹è¯•å’Œæ‰©å±•
3. **å¼‚æ­¥ä¼˜å…ˆ** - å…¨ç¨‹ä½¿ç”¨async/await
4. **é”™è¯¯å¤„ç†è¦å…¨é¢** - ç½‘ç»œç¼–ç¨‹é”™è¯¯æƒ…å†µå¤š
5. **æ—¥å¿—å¾ˆé‡è¦** - ä¾¿äºè°ƒè¯•ç½‘ç»œé—®é¢˜
6. **æ€§èƒ½ç›‘æ§** - åŠæ—¶å‘ç°æ€§èƒ½ç“¶é¢ˆ

---

> ğŸ¯ **é˜¶æ®µç›®æ ‡**: å®Œæˆæœ¬é˜¶æ®µåï¼Œåº”è¯¥èƒ½å¤ŸæˆåŠŸä¸WebSocketæœåŠ¡å™¨å»ºç«‹è¿æ¥å¹¶å®Œæˆæ¡æ‰‹ï¼Œä¸ºä¸‹ä¸€é˜¶æ®µçš„å¸§å¤„ç†å¥ å®šåŸºç¡€ã€‚